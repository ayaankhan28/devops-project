name: CD - Deploy to Production

on:
  workflow_run:
    workflows: ["CD - Deploy to Staging"]
    types:
      - completed
    branches: [master, main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Docker image tag to deploy (e.g., latest or commit SHA)'
        required: true
        default: 'latest'

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/devops-fastapi
  DEPLOYMENT_PORT: 8000
  ENVIRONMENT: production

jobs:
  deploy-production:
    name: Deploy to Production VM
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: production
      url: http://${{ secrets.VM_HOST }}:8000
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Determine Image Tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IMAGE_TAG="${{ github.event.inputs.version }}"
          else
            IMAGE_TAG="latest"
          fi
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Deploying image tag: ${IMAGE_TAG}"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VM_SSH_PORT || 22 }} -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ SSH configured"

      - name: Copy Deployment Script to VM
        run: |
          scp -i ~/.ssh/deploy_key \
              -P ${{ secrets.VM_SSH_PORT || 22 }} \
              scripts/vm-deploy.sh \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:~/deployments/scripts/
          echo "‚úÖ Deployment script copied to VM"

      - name: Pre-deployment Health Check
        run: |
          echo "üîç Checking current production status..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker ps | grep devops-fastapi-production || echo 'No production container running'"

      - name: Deploy to Production VM
        run: |
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "bash ~/deployments/scripts/vm-deploy.sh \
                ${{ env.ENVIRONMENT }} \
                ${{ env.DOCKER_IMAGE }} \
                ${{ steps.image_tag.outputs.IMAGE_TAG }} \
                ${{ env.DEPLOYMENT_PORT }}"

      - name: Verify Deployment
        run: |
          echo "üîç Verifying production deployment on VM..."
          max_attempts=15
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Verification attempt $attempt/$max_attempts"
            response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/health || echo "000")
            
            if [ $response -eq 200 ]; then
              echo "‚úÖ Production deployment verified - Health check passed"
              exit 0
            fi
            
            echo "‚è≥ Waiting for application to be ready..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          echo "‚ùå Verification failed after $max_attempts attempts"
          exit 1

      - name: Run Production Smoke Tests
        run: |
          echo "üß™ Running production smoke tests..."
          
          # Test health endpoint
          health_response=$(curl -s http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/health)
          echo "Health Response: $health_response"
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/health || exit 1
          echo "‚úÖ Health endpoint test passed"
          
          # Test items endpoint
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/items || exit 1
          echo "‚úÖ Items endpoint test passed"
          
          # Test root endpoint
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/ || exit 1
          echo "‚úÖ Root endpoint test passed"
          
          # Test API documentation
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/docs || exit 1
          echo "‚úÖ API documentation accessible"
          
          echo "‚úÖ All production smoke tests passed"

      - name: Performance Check
        run: |
          echo "‚ö° Running performance checks..."
          
          # Test response time
          response_time=$(curl -o /dev/null -s -w '%{time_total}\n' http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/health)
          echo "Response time: ${response_time}s"
          
          # Check if response time is acceptable (less than 2 seconds)
          if (( $(echo "$response_time < 2.0" | bc -l) )); then
            echo "‚úÖ Performance check passed"
          else
            echo "‚ö†Ô∏è Warning: Response time is higher than expected"
          fi

      - name: Get Container Status
        if: always()
        run: |
          echo "üìä Production Container Status on VM:"
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker ps | grep devops-fastapi-production || echo 'Container not running'"

      - name: Get Container Stats
        if: success()
        run: |
          echo "üìà Container Resource Usage:"
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker stats devops-fastapi-production --no-stream --format 'table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}' || echo 'Stats not available'"

      - name: Get Container Logs
        if: failure()
        run: |
          echo "üìã Production Container Logs:"
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker logs devops-fastapi-production --tail 100 || echo 'No logs available'"

      - name: Cleanup Old Docker Images
        if: success()
        run: |
          echo "üßπ Cleaning up old Docker images on VM..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker image prune -f || true"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "‚úÖ SSH cleanup completed"

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ Production Deployment Summary"
          echo "================================"
          echo "Environment: Production"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}"
          echo "VM Host: ${{ secrets.VM_HOST }}"
          echo "Port: ${{ env.DEPLOYMENT_PORT }}"
          echo "Status: ‚úÖ Deployed Successfully"
          echo "Deployed at: $(date)"
          echo "Trigger: ${{ github.event_name }}"
          echo "URL: http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}"
          echo "================================"

      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Production deployment completed successfully"
            echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}"
            echo "VM: ${{ secrets.VM_HOST }}"
            echo "Trigger: ${{ github.event_name }}"
          else
            echo "‚ùå Production deployment failed"
            echo "VM: ${{ secrets.VM_HOST }}"
            echo "Please check the logs and take necessary action"
          fi
