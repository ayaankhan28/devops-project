name: CD - Deploy to Staging

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [master, main]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/devops-fastapi
  DEPLOYMENT_PORT: 8001
  ENVIRONMENT: staging

jobs:
  deploy-staging:
    name: Deploy to Staging VM
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: staging
      url: http://${{ secrets.VM_HOST }}:8001
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VM_SSH_PORT || 22 }} -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ SSH configured"

      - name: Copy Deployment Script to VM
        run: |
          scp -i ~/.ssh/deploy_key \
              -P ${{ secrets.VM_SSH_PORT || 22 }} \
              scripts/vm-deploy.sh \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:~/deployments/scripts/
          echo "‚úÖ Deployment script copied to VM"

      - name: Deploy to Staging VM
        run: |
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "bash ~/deployments/scripts/vm-deploy.sh \
                ${{ env.ENVIRONMENT }} \
                ${{ env.DOCKER_IMAGE }} \
                latest \
                ${{ env.DEPLOYMENT_PORT }}"

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment on VM..."
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Verification attempt $attempt/$max_attempts"
            response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/health || echo "000")
            
            if [ $response -eq 200 ]; then
              echo "‚úÖ Staging deployment verified - Health check passed"
              exit 0
            fi
            
            echo "‚è≥ Waiting for application to be ready..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          echo "‚ùå Verification failed after $max_attempts attempts"
          exit 1

      - name: Run Remote Smoke Tests
        run: |
          echo "üß™ Running smoke tests on staging VM..."
          
          # Test health endpoint
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/health || exit 1
          echo "‚úÖ Health endpoint test passed"
          
          # Test items endpoint
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/items || exit 1
          echo "‚úÖ Items endpoint test passed"
          
          # Test root endpoint
          curl -f http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}/ || exit 1
          echo "‚úÖ Root endpoint test passed"
          
          echo "‚úÖ All smoke tests passed"

      - name: Get Container Status
        if: always()
        run: |
          echo "üìä Container Status on VM:"
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker ps | grep devops-fastapi-staging || echo 'Container not running'"

      - name: Get Container Logs
        if: failure()
        run: |
          echo "üìã Container Logs:"
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.VM_SSH_PORT || 22 }} \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "docker logs devops-fastapi-staging --tail 100 || echo 'No logs available'"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "‚úÖ SSH cleanup completed"

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ Staging Deployment Summary"
          echo "================================"
          echo "Environment: Staging"
          echo "Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "VM Host: ${{ secrets.VM_HOST }}"
          echo "Port: ${{ env.DEPLOYMENT_PORT }}"
          echo "Status: ‚úÖ Deployed Successfully"
          echo "URL: http://${{ secrets.VM_HOST }}:${{ env.DEPLOYMENT_PORT }}"
          echo "================================"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Staging Deployment Failed"
          echo "Please check the logs and VM status"
          echo "VM: ${{ secrets.VM_HOST }}"
          echo "Environment: staging"
